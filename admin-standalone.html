<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم الإدارية - KYC</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    * {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .spinner {
      border: 4px solid rgba(212, 175, 55, 0.2);
      border-top-color: #D4AF37;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-backdrop {
      backdrop-filter: blur(8px);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: #D4AF37;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #b8941f;
    }

    /* Dark mode styles */
    .dark {
      background-color: #0D1412;
      color: #E8E8E8;
    }

    .dark .bg-light-surface { background-color: #1A1F1D; }
    .dark .bg-light-base { background-color: #0D1412; }
    .dark .text-light-text { color: #E8E8E8; }
    .dark .text-light-text-secondary { color: #A0A0A0; }
    .dark .border-light-border { border-color: rgba(255, 255, 255, 0.1); }

    /* Light mode default */
    .bg-light-surface { background-color: #FFFFFF; }
    .bg-light-base { background-color: #FAFAFA; }
    .text-light-text { color: #1A1A1A; }
    .text-light-text-secondary { color: #6B7280; }
    .border-light-border { border-color: rgba(0, 0, 0, 0.1); }
  </style>

  <script>
    // Tailwind configuration
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'dark-base': '#0D1412',
            'dark-surface': '#1A1F1D',
            'dark-text': '#E8E8E8',
            'dark-text-secondary': '#A0A0A0',
            'light-base': '#FAFAFA',
            'light-surface': '#FFFFFF',
            'light-text': '#1A1A1A',
            'light-text-secondary': '#6B7280',
            'lime-accent': '#D4AF37',
          }
        }
      }
    };
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    const { useState, useEffect, useCallback, createContext, useContext } = React;

    // ===== Firebase Configuration =====
    const firebaseConfig = {
      apiKey: "AIzaSyC1BXRLXf-qgCmfaBsVBJn3zowuNSunqqU",
      authDomain: "bank-2af38.firebaseapp.com",
      databaseURL: "https://bank-2af38-default-rtdb.firebaseio.com",
      projectId: "bank-2af38",
      storageBucket: "bank-2af38.firebasestorage.app",
      messagingSenderId: "245118667564",
      appId: "1:245118667564:web:15d24ee9d4079c7a703a89",
      measurementId: "G-QSKDRCVCZ7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ===== Theme Context =====
    const ThemeContext = createContext();

    function ThemeProvider({ children }) {
      const [theme, setTheme] = useState(() => {
        return localStorage.getItem('admin-theme') || 'dark';
      });

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme === 'dark');
        localStorage.setItem('admin-theme', theme);
      }, [theme]);

      const toggleTheme = () => {
        setTheme(prev => prev === 'dark' ? 'light' : 'dark');
      };

      return React.createElement(ThemeContext.Provider, { value: { theme, toggleTheme } }, children);
    }

    function useTheme() {
      return useContext(ThemeContext);
    }

    // ===== Icons Components =====
    function Icon({ name, className = "w-5 h-5", ...props }) {
      useEffect(() => {
        lucide.createIcons();
      }, []);

      return React.createElement('i', {
        'data-lucide': name,
        className,
        ...props
      });
    }

    // ===== Hooks =====
    function useKYCSubmissions() {
      const [submissions, setSubmissions] = useState([]);
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({
        total: 0,
        pending: 0,
        under_review: 0,
        approved: 0,
        rejected: 0
      });

      useEffect(() => {
        const unsubscribe = db.collection('kyc_submissions')
          .orderBy('submission_date', 'desc')
          .onSnapshot(snapshot => {
            const submissionsList = [];
            snapshot.forEach(doc => {
              const data = doc.data();
              submissionsList.push({
                id: doc.id,
                user_id: data.user_id,
                national_id_url: data.national_id_url || null,
                passport_url: data.passport_url || null,
                selfie_url: data.selfie_url || null,
                status: data.status,
                admin_notes: data.admin_notes || null,
                reviewed_by: data.reviewed_by || null,
                reviewed_at: data.reviewed_at?.toDate?.()?.toISOString() || null,
                rejection_reason: data.rejection_reason || null,
                submission_date: data.submission_date?.toDate?.()?.toISOString() || new Date().toISOString(),
              });
            });

            setSubmissions(submissionsList);
            setStats({
              total: submissionsList.length,
              pending: submissionsList.filter(s => s.status === 'pending').length,
              under_review: submissionsList.filter(s => s.status === 'under_review').length,
              approved: submissionsList.filter(s => s.status === 'approved').length,
              rejected: submissionsList.filter(s => s.status === 'rejected').length
            });
            setLoading(false);
          }, error => {
            console.error('Error fetching submissions:', error);
            setLoading(false);
          });

        return () => unsubscribe();
      }, []);

      const updateSubmissionStatus = async (submissionId, status, adminId, notes, rejectionReason) => {
        try {
          const oldSubmission = submissions.find(s => s.id === submissionId);

          await db.collection('kyc_submissions').doc(submissionId).update({
            status,
            reviewed_by: adminId,
            reviewed_at: firebase.firestore.FieldValue.serverTimestamp(),
            admin_notes: notes || null,
            rejection_reason: rejectionReason || null,
            updated_at: firebase.firestore.FieldValue.serverTimestamp()
          });

          // Audit log
          await db.collection('kyc_audit_log').add({
            submission_id: submissionId,
            admin_id: adminId,
            action: 'status_change',
            old_status: oldSubmission?.status || null,
            new_status: status,
            notes: notes || null,
            ip_address: null,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });

          // Notification
          const submission = submissions.find(s => s.id === submissionId);
          if (submission) {
            const notificationTypes = {
              under_review: {
                type: 'under_review',
                title: 'طلبك قيد المراجعة',
                message: 'فريقنا يقوم الآن بمراجعة مستنداتك.'
              },
              approved: {
                type: 'approved',
                title: 'تم الموافقة على طلبك',
                message: 'تم التحقق من هويتك بنجاح!'
              },
              rejected: {
                type: 'rejected',
                title: 'تم رفض طلبك',
                message: rejectionReason || 'للأسف، لم يتم قبول المستندات المقدمة.'
              }
            };

            if (notificationTypes[status]) {
              await db.collection('kyc_notifications').add({
                user_id: submission.user_id,
                submission_id: submissionId,
                type: notificationTypes[status].type,
                title: notificationTypes[status].title,
                message: notificationTypes[status].message,
                is_read: false,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
          }
        } catch (error) {
          console.error('Error updating submission:', error);
          throw error;
        }
      };

      return { submissions, loading, stats, updateSubmissionStatus };
    }

    // ===== Components =====
    function AdminLogin() {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState(null);
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError(null);
        setLoading(true);

        try {
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          const idTokenResult = await userCredential.user.getIdTokenResult();

          if (idTokenResult.claims.role !== 'admin') {
            await auth.signOut();
            throw new Error('ليس لديك صلاحيات الوصول لهذه اللوحة');
          }
        } catch (err) {
          console.error('Login error:', err);
          setError(err.message || 'فشل تسجيل الدخول. يرجى التحقق من البيانات.');
        } finally {
          setLoading(false);
        }
      };

      return React.createElement('div', {
        className: 'min-h-screen bg-gradient-to-br from-light-base via-light-surface to-light-base dark:from-dark-base dark:via-dark-surface dark:to-dark-base flex items-center justify-center p-4'
      },
        React.createElement('div', { className: 'w-full max-w-md fade-in' },
          React.createElement('div', {
            className: 'bg-light-surface dark:bg-dark-surface backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-light-border dark:border-dark-border'
          },
            React.createElement('div', { className: 'text-center mb-8' },
              React.createElement('div', {
                className: 'w-20 h-20 bg-gradient-to-br from-lime-accent to-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg'
              },
                React.createElement(Icon, { name: 'shield', className: 'w-10 h-10 text-white' })
              ),
              React.createElement('h1', {
                className: 'text-3xl font-bold text-light-text dark:text-dark-text mb-2'
              }, 'لوحة التحكم الإدارية'),
              React.createElement('p', {
                className: 'text-light-text-secondary dark:text-dark-text-secondary'
              }, 'مراجعة طلبات التحقق من الهوية (KYC)')
            ),
            React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' },
              React.createElement('div', {},
                React.createElement('label', {
                  className: 'block text-sm font-medium text-light-text dark:text-dark-text mb-2'
                }, 'البريد الإلكتروني'),
                React.createElement('div', { className: 'relative' },
                  React.createElement(Icon, {
                    name: 'mail',
                    className: 'absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-light-text-secondary dark:text-dark-text-secondary'
                  }),
                  React.createElement('input', {
                    type: 'email',
                    value: email,
                    onChange: (e) => setEmail(e.target.value),
                    required: true,
                    className: 'w-full pr-11 pl-4 py-3 bg-light-base dark:bg-dark-base border border-light-border dark:border-dark-border rounded-xl text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-lime-accent transition-all',
                    placeholder: 'admin@example.com'
                  })
                )
              ),
              React.createElement('div', {},
                React.createElement('label', {
                  className: 'block text-sm font-medium text-light-text dark:text-dark-text mb-2'
                }, 'كلمة المرور'),
                React.createElement('div', { className: 'relative' },
                  React.createElement(Icon, {
                    name: 'lock',
                    className: 'absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-light-text-secondary dark:text-dark-text-secondary'
                  }),
                  React.createElement('input', {
                    type: 'password',
                    value: password,
                    onChange: (e) => setPassword(e.target.value),
                    required: true,
                    className: 'w-full pr-11 pl-4 py-3 bg-light-base dark:bg-dark-base border border-light-border dark:border-dark-border rounded-xl text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-lime-accent transition-all',
                    placeholder: '••••••••'
                  })
                )
              ),
              error && React.createElement('div', {
                className: 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 flex items-start gap-3 fade-in'
              },
                React.createElement(Icon, { name: 'alert-circle', className: 'w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5' }),
                React.createElement('p', { className: 'text-sm text-red-800 dark:text-red-200' }, error)
              ),
              React.createElement('button', {
                type: 'submit',
                disabled: loading,
                className: 'w-full px-6 py-3 bg-gradient-to-r from-lime-accent to-yellow-500 text-white rounded-xl font-bold hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg'
              }, loading ? 'جاري تسجيل الدخول...' : 'تسجيل الدخول')
            ),
            React.createElement('div', {
              className: 'mt-6 pt-6 border-t border-light-border dark:border-dark-border'
            },
              React.createElement('p', {
                className: 'text-xs text-center text-light-text-secondary dark:text-dark-text-secondary'
              }, 'هذه اللوحة مخصصة للمسؤولين فقط. جميع الأنشطة مسجلة ومراقبة.')
            )
          )
        )
      );
    }

    function KYCReviewModal({ submissionId, onClose, onUpdate, adminId }) {
      const [submission, setSubmission] = useState(null);
      const [loading, setLoading] = useState(true);
      const [updating, setUpdating] = useState(false);
      const [notes, setNotes] = useState('');
      const [rejectionReason, setRejectionReason] = useState('');
      const [selectedAction, setSelectedAction] = useState(null);

      useEffect(() => {
        fetchSubmission();
      }, [submissionId]);

      const fetchSubmission = async () => {
        try {
          const doc = await db.collection('kyc_submissions').doc(submissionId).get();
          if (!doc.exists) throw new Error('Submission not found');

          const data = doc.data();
          const submissionData = {
            id: doc.id,
            user_id: data.user_id,
            national_id_url: data.national_id_url || null,
            passport_url: data.passport_url || null,
            selfie_url: data.selfie_url || null,
            status: data.status,
            admin_notes: data.admin_notes || null,
            reviewed_by: data.reviewed_by || null,
            reviewed_at: data.reviewed_at?.toDate?.()?.toISOString() || null,
            rejection_reason: data.rejection_reason || null,
            submission_date: data.submission_date?.toDate?.()?.toISOString() || new Date().toISOString()
          };

          setSubmission(submissionData);
          setNotes(submissionData.admin_notes || '');
          setRejectionReason(submissionData.rejection_reason || '');
        } catch (error) {
          console.error('Error fetching submission:', error);
        } finally {
          setLoading(false);
        }
      };

      const handleApprove = async () => {
        try {
          setUpdating(true);
          await onUpdate(submissionId, 'approved', adminId, notes);
          onClose();
        } catch (error) {
          console.error('Error approving:', error);
        } finally {
          setUpdating(false);
        }
      };

      const handleReject = async () => {
        if (!rejectionReason.trim()) {
          alert('يرجى كتابة سبب الرفض');
          return;
        }
        try {
          setUpdating(true);
          await onUpdate(submissionId, 'rejected', adminId, notes, rejectionReason);
          onClose();
        } catch (error) {
          console.error('Error rejecting:', error);
        } finally {
          setUpdating(false);
        }
      };

      const handleMarkUnderReview = async () => {
        try {
          setUpdating(true);
          await onUpdate(submissionId, 'under_review', adminId, notes);
          await fetchSubmission();
        } catch (error) {
          console.error('Error updating:', error);
        } finally {
          setUpdating(false);
        }
      };

      if (loading) {
        return React.createElement('div', {
          className: 'fixed inset-0 bg-black/50 modal-backdrop z-50 flex items-center justify-center'
        },
          React.createElement('div', {
            className: 'bg-light-surface dark:bg-dark-surface rounded-3xl p-8'
          },
            React.createElement('div', {
              className: 'w-16 h-16 spinner mx-auto'
            })
          )
        );
      }

      if (!submission) return null;

      return React.createElement('div', {
        className: 'fixed inset-0 bg-black/50 modal-backdrop z-50 flex items-center justify-center p-4 overflow-y-auto',
        onClick: onClose
      },
        React.createElement('div', {
          className: 'bg-light-surface dark:bg-dark-surface rounded-3xl shadow-2xl max-w-5xl w-full my-8 fade-in',
          onClick: (e) => e.stopPropagation()
        },
          // Header
          React.createElement('div', {
            className: 'bg-light-surface dark:bg-dark-surface border-b border-light-border dark:border-dark-border p-6 rounded-t-3xl'
          },
            React.createElement('div', { className: 'flex items-center justify-between' },
              React.createElement('div', {},
                React.createElement('h2', {
                  className: 'text-2xl font-bold text-light-text dark:text-dark-text mb-1'
                }, 'مراجعة طلب التحقق'),
                React.createElement('p', {
                  className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary font-mono'
                }, submission.id)
              ),
              React.createElement('button', {
                onClick: onClose,
                className: 'p-2 hover:bg-light-base dark:hover:bg-dark-base rounded-full transition-colors'
              },
                React.createElement(Icon, { name: 'x', className: 'w-6 h-6 text-light-text-secondary dark:text-dark-text-secondary' })
              )
            )
          ),

          // Content
          React.createElement('div', {
            className: 'p-6 space-y-6 max-h-[calc(100vh-16rem)] overflow-y-auto'
          },
            // Images
            React.createElement('div', { className: 'grid grid-cols-1 lg:grid-cols-3 gap-4' },
              ['national_id_url', 'passport_url', 'selfie_url'].map((field, idx) => {
                const titles = ['الهوية الوطنية', 'جواز السفر', 'الصورة الشخصية'];
                const icons = ['file-text', 'file-text', 'camera'];

                return React.createElement('div', { key: field, className: 'space-y-2' },
                  React.createElement('div', { className: 'flex items-center gap-2 text-light-text-secondary dark:text-dark-text-secondary mb-2' },
                    React.createElement(Icon, { name: icons[idx], className: 'w-4 h-4' }),
                    React.createElement('h3', { className: 'font-semibold' }, titles[idx])
                  ),
                  submission[field] ? React.createElement('a', {
                    href: submission[field],
                    target: '_blank',
                    rel: 'noopener noreferrer',
                    className: 'block'
                  },
                    React.createElement('img', {
                      src: submission[field],
                      alt: titles[idx],
                      className: 'w-full h-64 object-cover rounded-xl border-2 border-light-border dark:border-dark-border hover:border-lime-accent transition-colors cursor-pointer'
                    })
                  ) : React.createElement('div', {
                    className: 'w-full h-64 bg-light-base dark:bg-dark-base rounded-xl flex items-center justify-center'
                  },
                    React.createElement('p', {
                      className: 'text-light-text-secondary dark:text-dark-text-secondary'
                    }, 'لا توجد صورة')
                  )
                );
              })
            ),

            // Info
            React.createElement('div', {
              className: 'bg-light-base dark:bg-dark-base rounded-xl p-4 space-y-3'
            },
              React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                React.createElement('div', {},
                  React.createElement('p', {
                    className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary mb-1'
                  }, 'معرف المستخدم'),
                  React.createElement('p', {
                    className: 'text-sm font-mono text-light-text dark:text-dark-text'
                  }, submission.user_id)
                ),
                React.createElement('div', {},
                  React.createElement('p', {
                    className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary mb-1'
                  }, 'تاريخ التقديم'),
                  React.createElement('p', {
                    className: 'text-sm text-light-text dark:text-dark-text'
                  }, new Date(submission.submission_date).toLocaleDateString('ar-SA'))
                ),
                React.createElement('div', {},
                  React.createElement('p', {
                    className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary mb-1'
                  }, 'الحالة الحالية'),
                  React.createElement('p', {
                    className: 'text-sm font-semibold text-light-text dark:text-dark-text'
                  }, submission.status)
                )
              )
            ),

            // Notes
            React.createElement('div', { className: 'space-y-3' },
              React.createElement('label', {
                className: 'block text-sm font-semibold text-light-text dark:text-dark-text'
              }, 'ملاحظات المراجعة'),
              React.createElement('textarea', {
                value: notes,
                onChange: (e) => setNotes(e.target.value),
                rows: 3,
                className: 'w-full px-4 py-3 bg-light-base dark:bg-dark-base border border-light-border dark:border-dark-border rounded-xl text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-lime-accent resize-none',
                placeholder: 'أضف ملاحظاتك هنا...'
              })
            ),

            // Rejection reason (conditional)
            selectedAction === 'reject' && React.createElement('div', {
              className: 'space-y-3 fade-in'
            },
              React.createElement('label', {
                className: 'block text-sm font-semibold text-red-600 dark:text-red-400'
              }, 'سبب الرفض *'),
              React.createElement('textarea', {
                value: rejectionReason,
                onChange: (e) => setRejectionReason(e.target.value),
                rows: 3,
                className: 'w-full px-4 py-3 bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-xl text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-red-500 resize-none',
                placeholder: 'اشرح السبب بالتفصيل...'
              })
            )
          ),

          // Footer
          React.createElement('div', {
            className: 'bg-light-surface dark:bg-dark-surface border-t border-light-border dark:border-dark-border p-6 rounded-b-3xl'
          },
            React.createElement('div', { className: 'flex flex-wrap gap-3' },
              submission.status === 'pending' && React.createElement('button', {
                onClick: handleMarkUnderReview,
                disabled: updating,
                className: 'flex-1 sm:flex-none px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-medium transition-colors disabled:opacity-50 flex items-center justify-center gap-2'
              },
                React.createElement(Icon, { name: 'alert-triangle', className: 'w-5 h-5' }),
                'قيد المراجعة'
              ),
              submission.status !== 'approved' && React.createElement('button', {
                onClick: () => selectedAction === 'approve' ? handleApprove() : setSelectedAction('approve'),
                disabled: updating,
                className: 'flex-1 sm:flex-none px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium transition-colors disabled:opacity-50 flex items-center justify-center gap-2'
              },
                React.createElement(Icon, { name: 'check-circle', className: 'w-5 h-5' }),
                selectedAction === 'approve' ? 'تأكيد الموافقة' : 'الموافقة'
              ),
              submission.status !== 'rejected' && React.createElement('button', {
                onClick: () => selectedAction === 'reject' ? handleReject() : setSelectedAction('reject'),
                disabled: updating,
                className: 'flex-1 sm:flex-none px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium transition-colors disabled:opacity-50 flex items-center justify-center gap-2'
              },
                React.createElement(Icon, { name: 'x-circle', className: 'w-5 h-5' }),
                selectedAction === 'reject' ? 'تأكيد الرفض' : 'رفض'
              ),
              React.createElement('button', {
                onClick: onClose,
                disabled: updating,
                className: 'flex-1 sm:flex-none px-6 py-3 bg-light-base dark:bg-dark-base text-light-text dark:text-dark-text rounded-xl font-medium hover:opacity-80 transition-opacity disabled:opacity-50'
              }, 'إغلاق')
            ),
            selectedAction && React.createElement('p', {
              className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary text-center mt-4 fade-in'
            }, selectedAction === 'approve' ? 'انقر مرة أخرى للتأكيد' : 'يرجى كتابة سبب الرفض ثم النقر للتأكيد')
          )
        )
      );
    }

    function AdminDashboard({ user }) {
      const { submissions, loading, stats, updateSubmissionStatus } = useKYCSubmissions();
      const [selectedSubmission, setSelectedSubmission] = useState(null);
      const [filterStatus, setFilterStatus] = useState('all');
      const [searchQuery, setSearchQuery] = useState('');
      const { theme, toggleTheme } = useTheme();

      const handleLogout = async () => {
        try {
          await auth.signOut();
        } catch (error) {
          console.error('Logout error:', error);
        }
      };

      const filteredSubmissions = submissions.filter(submission => {
        const matchesFilter = filterStatus === 'all' || submission.status === filterStatus;
        const matchesSearch = submission.user_id.toLowerCase().includes(searchQuery.toLowerCase()) ||
                            submission.id.toLowerCase().includes(searchQuery.toLowerCase());
        return matchesFilter && matchesSearch;
      });

      const statCards = [
        { title: 'إجمالي الطلبات', value: stats.total, icon: 'users', color: 'from-blue-500 to-cyan-500' },
        { title: 'قيد الانتظار', value: stats.pending, icon: 'clock', color: 'from-amber-500 to-orange-500' },
        { title: 'تمت الموافقة', value: stats.approved, icon: 'check-circle', color: 'from-green-500 to-emerald-500' },
        { title: 'مرفوضة', value: stats.rejected, icon: 'x-circle', color: 'from-red-500 to-rose-500' }
      ];

      const statusConfig = {
        pending: { label: 'قيد الانتظار', color: 'text-blue-600', bg: 'bg-blue-100' },
        under_review: { label: 'قيد المراجعة', color: 'text-amber-600', bg: 'bg-amber-100' },
        approved: { label: 'موافق عليه', color: 'text-green-600', bg: 'bg-green-100' },
        rejected: { label: 'مرفوض', color: 'text-red-600', bg: 'bg-red-100' }
      };

      return React.createElement('div', { className: 'min-h-screen bg-light-base dark:bg-dark-base' },
        // Header
        React.createElement('header', {
          className: 'sticky top-0 z-40 bg-light-surface/80 dark:bg-dark-surface/80 backdrop-blur-xl border-b border-light-border dark:border-dark-border'
        },
          React.createElement('div', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4' },
            React.createElement('div', { className: 'flex items-center justify-between' },
              React.createElement('div', {},
                React.createElement('h1', {
                  className: 'text-2xl font-bold text-light-text dark:text-dark-text'
                }, 'لوحة التحكم الإدارية'),
                React.createElement('p', {
                  className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary'
                }, `مرحباً، ${user.email}`)
              ),
              React.createElement('div', { className: 'flex items-center gap-3' },
                React.createElement('button', {
                  onClick: toggleTheme,
                  className: 'p-2 hover:bg-light-base dark:hover:bg-dark-base rounded-full transition-colors'
                },
                  React.createElement(Icon, {
                    name: theme === 'dark' ? 'sun' : 'moon',
                    className: 'w-5 h-5 text-light-text-secondary dark:text-dark-text-secondary'
                  })
                ),
                React.createElement('button', {
                  onClick: handleLogout,
                  className: 'flex items-center gap-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl transition-colors'
                },
                  React.createElement(Icon, { name: 'log-out', className: 'w-4 h-4' }),
                  React.createElement('span', { className: 'hidden sm:inline' }, 'تسجيل الخروج')
                )
              )
            )
          )
        ),

        // Main content
        React.createElement('main', { className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8' },
          // Stats cards
          React.createElement('div', { className: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8' },
            statCards.map((stat, idx) => React.createElement('div', {
              key: stat.title,
              className: 'bg-light-surface dark:bg-dark-surface rounded-2xl p-6 border border-light-border dark:border-dark-border shadow-lg fade-in',
              style: { animationDelay: `${idx * 0.1}s` }
            },
              React.createElement('div', { className: 'flex items-center justify-between mb-4' },
                React.createElement('div', {
                  className: `w-12 h-12 bg-gradient-to-br ${stat.color} rounded-xl flex items-center justify-center shadow-lg`
                },
                  React.createElement(Icon, { name: stat.icon, className: 'w-6 h-6 text-white' })
                )
              ),
              React.createElement('h3', {
                className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary mb-1'
              }, stat.title),
              React.createElement('p', {
                className: 'text-3xl font-bold text-light-text dark:text-dark-text'
              }, stat.value)
            ))
          ),

          // Table
          React.createElement('div', {
            className: 'bg-light-surface dark:bg-dark-surface rounded-2xl border border-light-border dark:border-dark-border shadow-lg overflow-hidden'
          },
            // Filters
            React.createElement('div', {
              className: 'p-6 border-b border-light-border dark:border-dark-border'
            },
              React.createElement('div', { className: 'flex flex-col sm:flex-row gap-4' },
                React.createElement('div', { className: 'flex-1 relative' },
                  React.createElement(Icon, {
                    name: 'search',
                    className: 'absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-light-text-secondary dark:text-dark-text-secondary'
                  }),
                  React.createElement('input', {
                    type: 'text',
                    value: searchQuery,
                    onChange: (e) => setSearchQuery(e.target.value),
                    placeholder: 'بحث بمعرف المستخدم أو معرف الطلب...',
                    className: 'w-full pr-11 pl-4 py-3 bg-light-base dark:bg-dark-base border border-light-border dark:border-dark-border rounded-xl text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-lime-accent transition-all'
                  })
                ),
                React.createElement('div', { className: 'relative' },
                  React.createElement(Icon, {
                    name: 'filter',
                    className: 'absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-light-text-secondary dark:text-dark-text-secondary pointer-events-none'
                  }),
                  React.createElement('select', {
                    value: filterStatus,
                    onChange: (e) => setFilterStatus(e.target.value),
                    className: 'w-full sm:w-auto pr-11 pl-4 py-3 bg-light-base dark:bg-dark-base border border-light-border dark:border-dark-border rounded-xl text-light-text dark:text-dark-text focus:outline-none focus:ring-2 focus:ring-lime-accent transition-all appearance-none cursor-pointer'
                  },
                    React.createElement('option', { value: 'all' }, 'جميع الحالات'),
                    React.createElement('option', { value: 'pending' }, 'قيد الانتظار'),
                    React.createElement('option', { value: 'under_review' }, 'قيد المراجعة'),
                    React.createElement('option', { value: 'approved' }, 'موافق عليه'),
                    React.createElement('option', { value: 'rejected' }, 'مرفوض')
                  )
                )
              )
            ),

            // Table content
            loading ? React.createElement('div', { className: 'p-12 text-center' },
              React.createElement('div', { className: 'w-16 h-16 spinner mx-auto mb-4' }),
              React.createElement('p', {
                className: 'text-light-text-secondary dark:text-dark-text-secondary'
              }, 'جاري التحميل...')
            ) : filteredSubmissions.length === 0 ? React.createElement('div', { className: 'p-12 text-center' },
              React.createElement('p', {
                className: 'text-light-text-secondary dark:text-dark-text-secondary'
              }, 'لا توجد طلبات')
            ) : React.createElement('div', { className: 'overflow-x-auto' },
              React.createElement('table', { className: 'w-full' },
                React.createElement('thead', { className: 'bg-light-base dark:bg-dark-base' },
                  React.createElement('tr', {},
                    ['معرف الطلب', 'معرف المستخدم', 'تاريخ التقديم', 'الحالة', 'إجراءات'].map(header =>
                      React.createElement('th', {
                        key: header,
                        className: 'px-6 py-4 text-right text-xs font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase tracking-wider'
                      }, header)
                    )
                  )
                ),
                React.createElement('tbody', {
                  className: 'divide-y divide-light-border dark:divide-dark-border'
                },
                  filteredSubmissions.map(submission => {
                    const config = statusConfig[submission.status];
                    return React.createElement('tr', {
                      key: submission.id,
                      className: 'hover:bg-light-base dark:hover:bg-dark-base transition-colors'
                    },
                      React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
                        React.createElement('span', {
                          className: 'text-sm font-mono text-light-text dark:text-dark-text'
                        }, submission.id.substring(0, 8) + '...')
                      ),
                      React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
                        React.createElement('span', {
                          className: 'text-sm font-mono text-light-text dark:text-dark-text'
                        }, submission.user_id.substring(0, 12) + '...')
                      ),
                      React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
                        React.createElement('span', {
                          className: 'text-sm text-light-text-secondary dark:text-dark-text-secondary'
                        }, new Date(submission.submission_date).toLocaleDateString('ar-SA'))
                      ),
                      React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
                        React.createElement('span', {
                          className: `inline-flex px-3 py-1 rounded-full text-xs font-medium ${config.bg} ${config.color}`
                        }, config.label)
                      ),
                      React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap' },
                        React.createElement('button', {
                          onClick: () => setSelectedSubmission(submission.id),
                          className: 'inline-flex items-center gap-2 px-4 py-2 bg-lime-accent hover:opacity-90 text-white rounded-lg text-sm font-medium transition-opacity'
                        },
                          React.createElement(Icon, { name: 'eye', className: 'w-4 h-4' }),
                          'مراجعة'
                        )
                      )
                    );
                  })
                )
              )
            )
          )
        ),

        // Modal
        selectedSubmission && React.createElement(KYCReviewModal, {
          submissionId: selectedSubmission,
          onClose: () => setSelectedSubmission(null),
          onUpdate: updateSubmissionStatus,
          adminId: user.uid
        })
      );
    }

    // ===== Main App =====
    function App() {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [user, setUser] = useState(null);
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (user) => {
          setUser(user);

          if (user) {
            const idTokenResult = await user.getIdTokenResult();
            const isAdmin = idTokenResult.claims.role === 'admin';
            setIsAuthenticated(!!user && isAdmin);
          } else {
            setIsAuthenticated(false);
          }

          setIsLoading(false);
        });

        return () => unsubscribe();
      }, []);

      if (isLoading) {
        return React.createElement('div', {
          className: 'min-h-screen bg-light-base dark:bg-dark-base flex items-center justify-center'
        },
          React.createElement('div', { className: 'text-center' },
            React.createElement('div', { className: 'w-16 h-16 spinner mx-auto mb-4' }),
            React.createElement('p', {
              className: 'text-light-text dark:text-dark-text'
            }, 'جاري التحميل...')
          )
        );
      }

      return React.createElement(ThemeProvider, {},
        !isAuthenticated
          ? React.createElement(AdminLogin)
          : React.createElement(AdminDashboard, { user })
      );
    }

    // ===== Render =====
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  </script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>